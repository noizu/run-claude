# =============================================================================
# run-claude Infrastructure Services
# =============================================================================
# Docker Compose with TimescaleDB and LiteLLM proxy.
#
# Secrets Configuration (automatic):
#   This compose file automatically loads secrets from:
#   1. $RUN_CLAUDE_HOME/.env (if RUN_CLAUDE_HOME is set)
#   2. ~/.config/run-claude/.env (default location)
#
#   Setup:
#   - Create secrets: run-claude secrets init
#   - Edit file: ~/.config/run-claude/.secrets
#   - Export for Docker: run-claude secrets export
#
# Usage:
#   docker compose up -d               # Start all services
#   docker compose logs -f             # View logs
#   docker compose down                # Stop services
#   docker compose down -v             # Stop and remove volumes
# =============================================================================

name: run-claude-infra

services:
  # ===========================================================================
  # TimescaleDB - PostgreSQL for application data
  # ===========================================================================
  timescaledb:
    image: timescale/timescaledb:2.23.1-pg17
    container_name: run-claude-timescaledb
    hostname: timescaledb
    env_file:
      - ${RUN_CLAUDE_HOME:-$HOME/.config/run-claude}/.env
    environment:
      - POSTGRES_USER=${RUN_CLAUDE_TIMESCALEDB_USER:-postgres}
      - POSTGRES_PASSWORD=${RUN_CLAUDE_TIMESCALEDB_PASSWORD}
      - POSTGRES_DB=${RUN_CLAUDE_TIMESCALEDB_DATABASE:-postgres}
      - TIMESCALEDB_TELEMETRY=off
    volumes:
      - timescaledb-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
      - internal

  # ===========================================================================
  # LiteLLM Proxy - AI model routing
  # ===========================================================================
  litellm:
    build:
      context: .
      dockerfile: litellm.Dockerfile
    image: run-claude-litellm:latest
    container_name: run-claude-litellm
    depends_on:
      timescaledb:
        condition: service_healthy
    env_file:
      - ${RUN_CLAUDE_HOME:-$HOME/.config/run-claude}/.env
    environment:
      - LITELLM_MASTER_KEY=${LITELLM_MASTER_KEY}
      # Override host-side DB URLs from .env with container-internal address
      - DATABASE_URL=postgresql://postgres:${RUN_CLAUDE_TIMESCALEDB_PASSWORD}@timescaledb:5432/postgres
      - LITELLM_DATABASE_URL=postgresql://postgres:${RUN_CLAUDE_TIMESCALEDB_PASSWORD}@timescaledb:5432/postgres
      - STORE_MODEL_IN_DB=True
      - USE_PRISMA_MIGRATE=True
    volumes:
      - ${RUN_CLAUDE_HOME:-$HOME/.config/run-claude}/litellm_config.yaml:/app/config/litellm_config.yaml:ro
      - litellm-logs:/var/log
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:4444/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s
    networks:
      - internal

# =============================================================================
# Networks
# =============================================================================
networks:
  internal:
    driver: bridge
    name: run-claude-network

# =============================================================================
# Volumes
# =============================================================================
volumes:
  timescaledb-data:
    name: run-claude-timescaledb-data
  litellm-logs:
    name: run-claude-litellm-logs
