# =============================================================================
# run-claude Database Service
# =============================================================================
# Minimal Docker Compose with only TimescaleDB database service
#
# Secrets Configuration (automatic):
#   This compose file automatically loads secrets from:
#   1. $RUN_CLAUDE_HOME/.env (if RUN_CLAUDE_HOME is set)
#   2. ~/.config/run-claude/.env (default location)
#
#   Setup:
#   - Create secrets: run-claude secrets init
#   - Edit file: ~/.config/run-claude/.secrets
#   - Export for Docker: run-claude secrets export
#
# Usage:
#   docker compose up -d               # Automatically loads .env
#   docker compose logs -f             # View logs
#   docker compose down                # Stop database
#   docker compose down -v             # Stop and remove volumes
#
#   Optional - override with custom location:
#   docker compose --env-file /path/to/.env up -d
# =============================================================================

name: run-claude-infra

services:
  # ===========================================================================
  # Database Service Only
  # ===========================================================================

  # TimescaleDB - PostgreSQL for application data
  timescaledb:
    image: timescale/timescaledb:2.23.1-pg17
    container_name: run-claude-timescaledb
    hostname: timescaledb
    env_file:
      # Automatically loads from $RUN_CLAUDE_HOME/.env or ~/.config/run-claude/.env
      # Set RUN_CLAUDE_HOME to override default location
      - ${RUN_CLAUDE_HOME:-$HOME/.config/run-claude}/.env
    environment:
      # Docker Compose expands these from .env file when containers are created
      # Variables come from: ~/.config/run-claude/.env (generated by run-claude secrets export)
      - POSTGRES_USER=${RUN_CLAUDE_TIMESCALEDB_USER:-postgres}
      - POSTGRES_PASSWORD=${RUN_CLAUDE_TIMESCALEDB_PASSWORD}
      - POSTGRES_DB=${RUN_CLAUDE_TIMESCALEDB_DATABASE:-postgres}
      - TIMESCALEDB_TELEMETRY=off
    volumes:
      - timescaledb-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
      - internal

# =============================================================================
# Networks
# =============================================================================
networks:
  internal:
    driver: bridge
    name: run-claude-network

# =============================================================================
# Volumes
# =============================================================================
volumes:
  timescaledb-data:
    name: run-claude-timescaledb-data
