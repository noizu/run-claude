# PRD-01: Env Variables & Setup Streamlining

**Phase**: 1A | **Est**: 2 days | **Repo**: run-claude

## Context

The current secrets/env flow has multiple sources of truth: `.secrets` (YAML), `.env` (flat), `.envrc` (shell), and hardcoded defaults in `proxy.py`. `LITELLM_MASTER_KEY` isn't in the secrets template, `DATABASE_URL` is constructed in 3 places, and `run-claude` itself doesn't load env vars from `~/.config/run-claude/.env` at runtime.

## Goals

1. Single source of truth: `.secrets` → `export` → `.env` → everything reads from `.env`
2. Auto-generate unique passwords/keys on first install (no `--generate` flag)
3. Post-install welcome message showing profile/model file locations

---

## 1a: Fix Env Variable Flow

### Current Flow (broken)
```
.secrets (YAML) → export → .env (key=value)
                              ↓
                    Docker Compose reads it
                    BUT: CLI doesn't load it
                    AND: DATABASE_URL built in 3 places
                    AND: LITELLM_MASTER_KEY hardcoded
```

### Target Flow
```
.secrets (YAML) → export → .env (key=value, includes LITELLM_MASTER_KEY, DATABASE_URL)
                              ↓
                ┌─────────────┼─────────────────┐
                ↓             ↓                 ↓
           CLI startup   Docker Compose   scripts/run-litellm-local
        (load_env_file)  (env_file:)      (source .env)
```

### Files to Modify

**`run_claude/config.py`** — Add 3 functions:

```python
def load_env_file(env_path: Path | None = None, debug: bool = False) -> dict[str, str]:
    """Load .env file into os.environ. Does NOT override existing vars.

    Default path: ~/.config/run-claude/.env
    Returns dict of loaded key-value pairs.
    """

def construct_database_url(password: str, host: str = "localhost", port: int = 5433) -> str:
    """Build fully-expanded DATABASE_URL. Single source of truth."""
    return f"postgresql://postgres:{password}@{host}:{port}/postgres?sslmode=disable"

def validate_env(required: list[str] | None = None) -> list[str]:
    """Check for missing/unexpanded env vars. Returns list of problems."""
    # Check for literal ${...} in values
    # Check required vars are set
    # Return [] if OK
```

**`run_claude/config.py`** — Enhance `export_env_file()`:

Add these vars to the exported `.env`:
- `LITELLM_MASTER_KEY` (from `.secrets`)
- `LITELLM_DATABASE_URL` (constructed via `construct_database_url()`)
- `DATABASE_URL` (same value, for Docker compatibility)
- `POSTGRES_PASSWORD` (derived from `RUN_CLAUDE_TIMESCALEDB_PASSWORD`)

**`run_claude/cli.py`** — Modify `main()`:

```python
def main():
    # Load .env BEFORE anything else
    config.load_env_file()
    ensure_initialized()
    # ... rest of CLI
```

**`run_claude/proxy.py`** — Remove DATABASE_URL duplication:

Replace all 3 instances of inline DATABASE_URL construction with `os.environ.get('LITELLM_DATABASE_URL')`. Affected functions:
- `generate_litellm_config()` (line ~246-258)
- `test_db_connection()`
- `run_prisma_migrate()`

### Migration Path

1. Add new functions (non-breaking)
2. Update `export_env_file()` to include new vars
3. Update CLI to load `.env` at startup
4. Remove inline DATABASE_URL construction from `proxy.py`
5. Existing `.env` files still work (new vars just get appended on next export)

---

## 1b: Auto-Generate Unique Passwords

### Files to Modify

**`run_claude/config.py`**:

```python
def generate_master_key() -> str:
    """Generate sk-litellm-{32-char-random} format key."""
    return f"sk-litellm-{generate_random_password(32)}"
```

Change defaults:
- `create_secrets_template(generate_passwords: bool = True)` (was `False`)
- Add `LITELLM_MASTER_KEY` to template with `generate_master_key()`
- Keep `ANTHROPIC_API_KEY` as placeholder (user must provide)
- Keep `--generate` flag for backward compat (becomes no-op with deprecation warning)

### Secrets Template (new)

```yaml
# Auto-generated by run-claude on {timestamp}
# File: ~/.config/run-claude/.secrets
# Permissions: 0600 (owner only)

# --- Required: Set your API key ---
ANTHROPIC_API_KEY: "sk-your-key-here"

# --- Auto-generated (change if needed) ---
RUN_CLAUDE_TIMESCALEDB_PASSWORD: "{generated_32_char}"
LITELLM_MASTER_KEY: "sk-litellm-{generated_32_char}"

# --- Optional provider keys ---
# OPENAI_API_KEY: ""
# CEREBRAS_API_KEY: ""
# GROQ_API_KEY: ""
```

---

## 1c: Post-Install Welcome Message

### Files to Modify

**`run_claude/cli.py`** — Add `print_welcome_message()`:

```python
def print_welcome_message():
    """Show post-install intro with file locations and next steps."""
    config_dir = get_config_dir()
    print(f"""
╭─────────────────────────────────────╮
│     run-claude installed!           │
╰─────────────────────────────────────╯

Configuration files:
  Secrets:   {config_dir}/.secrets
  Profiles:  {config_dir}/profiles.yaml
  Models:    {config_dir}/models.yaml
  Env:       {config_dir}/.env

Quick start:
  1. Edit your API key:
     $EDITOR {config_dir}/.secrets

  2. Export secrets to .env:
     run-claude secrets export

  3. Setup a project directory:
     cd ~/my-project
     run-claude set-folder anthropic

  4. Start using:
     run-claude proxy start

Customize profiles:
  run-claude profiles list          # see available profiles
  run-claude profiles show anthropic  # see profile details
  $EDITOR {config_dir}/profiles.yaml  # edit profiles
""")
```

Call from `cmd_install()` when files were actually installed (not when already initialized).

---

## Testing

### Unit Tests

```python
# tests/test_config.py
class TestLoadEnvFile:
    def test_loads_env_into_os_environ(self, tmp_path):
        env_file = tmp_path / ".env"
        env_file.write_text("FOO=bar\nBAZ=qux\n")
        loaded = load_env_file(env_file)
        assert os.environ["FOO"] == "bar"
        assert loaded == {"FOO": "bar", "BAZ": "qux"}

    def test_does_not_override_existing(self, tmp_path):
        os.environ["FOO"] = "original"
        env_file = tmp_path / ".env"
        env_file.write_text("FOO=new\n")
        load_env_file(env_file)
        assert os.environ["FOO"] == "original"

    def test_handles_missing_file(self):
        loaded = load_env_file(Path("/nonexistent/.env"))
        assert loaded == {}

class TestConstructDatabaseUrl:
    def test_default_url(self):
        url = construct_database_url("mypass")
        assert url == "postgresql://postgres:mypass@localhost:5433/postgres?sslmode=disable"

    def test_no_unexpanded_vars(self):
        url = construct_database_url("mypass")
        assert "${" not in url

class TestGenerateMasterKey:
    def test_format(self):
        key = generate_master_key()
        assert key.startswith("sk-litellm-")
        assert len(key) == len("sk-litellm-") + 32

class TestSecretsTemplateAutoGenerate:
    def test_generates_by_default(self):
        template = create_secrets_template()
        assert "your-postgres-password" not in template
        assert "sk-litellm-" in template
```

### Integration Test

```bash
# Fresh install flow
rm -rf ~/.config/run-claude/
run-claude install
# Verify: .secrets has unique passwords, .env exported, welcome shown
cat ~/.config/run-claude/.secrets | grep -c "sk-litellm-"  # should be 1
cat ~/.config/run-claude/.env | grep "LITELLM_MASTER_KEY"  # should exist
```

---

## Risks & Mitigations

| Risk | Mitigation |
|------|------------|
| Breaking existing `.secrets` files | New fields added only; existing files untouched unless re-init |
| `.env` loading order conflicts | `load_env_file()` never overrides existing vars |
| Missing `.env` at startup | Graceful fallback: warn, don't crash |
| `--generate` flag users confused | Deprecation warning: "passwords are now generated by default" |
