#!/bin/bash
# macOS wrapper for litellm that ensures Python 3.11 environment
set -e

LITELLM_HOME="${HOME}/.local/share/litellm"
VENV="${LITELLM_HOME}/.venv"

# Path to run-claude package for custom callbacks
# Can be overridden via environment variable
RUN_CLAUDE_PKG_PATH="${RUN_CLAUDE_PKG_PATH:-}"

# Marker file to track if run_claude needs reinstall
RUN_CLAUDE_MARKER="${VENV}/.run_claude_installed"

if [[ ! -d "$VENV" ]]; then
  echo "Setting up litellm environment with Python 3.11..."
  mkdir -p "$LITELLM_HOME"
  uv venv --python 3.11 "$VENV"
  source "$VENV/bin/activate"
  uv pip install 'litellm[proxy]' litellm-proxy-extras psycopg2-binary prometheus_client opentelemetry-api opentelemetry-sdk
  uv pip install prisma==0.11.0

  # Install run_claude for custom callbacks
  if [[ -n "$RUN_CLAUDE_PKG_PATH" && -d "$RUN_CLAUDE_PKG_PATH" ]]; then
    echo "Installing run_claude from: $RUN_CLAUDE_PKG_PATH"
    uv pip install -e "$RUN_CLAUDE_PKG_PATH"
    echo "$RUN_CLAUDE_PKG_PATH" > "$RUN_CLAUDE_MARKER"
  elif command -v run-claude &>/dev/null; then
    # Try to find run_claude package location from installed tool
    PKG_PATH="$(python -c 'import run_claude; import os; print(os.path.dirname(run_claude.__path__[0]))' 2>/dev/null || true)"
    if [[ -n "$PKG_PATH" && -d "$PKG_PATH" && -f "$PKG_PATH/pyproject.toml" ]]; then
      echo "Installing run_claude from detected path: $PKG_PATH"
      uv pip install -e "$PKG_PATH"
      echo "$PKG_PATH" > "$RUN_CLAUDE_MARKER"
    else
      echo "Warning: Could not find run_claude package path. Custom callbacks may not work."
      echo "Set RUN_CLAUDE_PKG_PATH environment variable to the run-claude source directory."
    fi
  fi
else
  source "$VENV/bin/activate"

  # Check if run_claude needs to be installed/updated
  if [[ -n "$RUN_CLAUDE_PKG_PATH" && -d "$RUN_CLAUDE_PKG_PATH" ]]; then
    CURRENT_PATH=""
    [[ -f "$RUN_CLAUDE_MARKER" ]] && CURRENT_PATH="$(cat "$RUN_CLAUDE_MARKER")"
    if [[ "$CURRENT_PATH" != "$RUN_CLAUDE_PKG_PATH" ]]; then
      echo "Updating run_claude from: $RUN_CLAUDE_PKG_PATH"
      uv pip install -e "$RUN_CLAUDE_PKG_PATH"
      echo "$RUN_CLAUDE_PKG_PATH" > "$RUN_CLAUDE_MARKER"
    fi
  fi
fi

# Create a modified schema.prisma with explicit output path to the venv
LITELLM_SCHEMA="$(python -c 'import litellm; print(litellm.__path__[0])')/proxy/schema.prisma"
PRISMA_OUTPUT="${VENV}/lib/python3.11/site-packages/prisma"
LOCAL_SCHEMA="${LITELLM_HOME}/schema.prisma"

# Copy and patch the schema to specify correct output
sed 's|generator client {|generator client {\n  output = "'"${PRISMA_OUTPUT}"'"|' "$LITELLM_SCHEMA" > "$LOCAL_SCHEMA"

# Run prisma generate with patched schema
python -m prisma generate --schema "$LOCAL_SCHEMA"

exec "$VENV/bin/litellm" "$@"
