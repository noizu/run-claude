#!/usr/bin/env bash
#
# with-agent-shim - Run a command with a specific Claude Switch profile
#
# Usage:
#   with-agent-shim <profile> -- <command> [args...]
#   with-agent-shim cerebras -- claude
#   with-agent-shim groq -- python script.py
#
# This wrapper:
# 1. Activates the specified profile (starts proxy, registers models)
# 2. Sets environment variables for the profile
# 3. Runs the command
# 4. Cleans up on exit (decrements refcounts)

set -euo pipefail

usage() {
    echo "Usage: with-agent-shim <profile> -- <command> [args...]"
    echo ""
    echo "Run a command with a specific Claude Switch profile."
    echo ""
    echo "Examples:"
    echo "  with-agent-shim cerebras -- claude"
    echo "  with-agent-shim groq -- python inference.py"
    echo "  with-agent-shim local -- ./my-script.sh"
    exit 1
}

# Parse arguments
if [[ $# -lt 1 ]]; then
    usage
fi

PROFILE="$1"
shift

# Handle optional -- separator
if [[ $# -gt 0 && "$1" == "--" ]]; then
    shift
fi

if [[ $# -lt 1 ]]; then
    usage
fi

# Generate ephemeral token
TOKEN="ephemeral-$(date +%s)-$$"

# Cleanup function
_cleanup() {
    run-claude leave "$TOKEN" 2>/dev/null || true
}

# Register cleanup for all exit scenarios
trap _cleanup EXIT INT TERM

# Activate profile
if ! run-claude enter "$TOKEN" "$PROFILE" 2>/dev/null; then
    echo "Warning: Failed to activate profile '$PROFILE'" >&2
fi

# Export environment variables
eval "$(run-claude env "$PROFILE" --export 2>/dev/null)" || {
    echo "Error: Failed to load environment for profile '$PROFILE'" >&2
    exit 1
}

# Run the command
exec "$@"
